CC = gcc
CFLAGS =

LD = ld
LDFLAGS =

MASTERFLAGS =
SLAVEFLAGS =

all: MASTERFLAGS = -DMODBUS_MASTER_REGISTERS=1 -DMODBUS_MASTER_COILS=1 -DMODBUS_MASTER_DISCRETE_INPUTS=1 -DMODBUS_MASTER_INPUT_REGISTERS=1
all: SLAVEFLAGS = -DMODBUS_SLAVE_REGISTERS=1 -DMODBUS_SLAVE_COILS=1 -DMODBUS_SLAVE_DISCRETE_INPUTS=1 -DMODBUS_SLAVE_INPUT_REGISTERS=1
all: CFLAGS += --coverage
all: clean
	mkdir test/modlib
	rsync -av . test/modlib
	cd test && $(CC) $(CFLAGS) -c modlib/src/master/mregisters.c
	cd test && $(CC) $(CFLAGS) -c modlib/src/slave/sregisters.c
	cd test && $(CC) $(CFLAGS) -c modlib/src/master/mcoils.c
	cd test && $(CC) $(CFLAGS) -c modlib/src/slave/scoils.c
	cd test && $(CC) $(CFLAGS) -c modlib/src/master/mdiscreteinputs.c
	cd test && $(CC) $(CFLAGS) -c modlib/src/slave/sdiscreteinputs.c
	cd test && $(CC) $(CFLAGS) -c modlib/src/master/minputregisters.c
	cd test && $(CC) $(CFLAGS) -c modlib/src/slave/sinputregisters.c
	cd test && $(CC) $(CFLAGS) $(MASTERFLAGS) -c modlib/src/master.c
	cd test && $(CC) $(CFLAGS) $(SLAVEFLAGS) -c modlib/src/slave.c
	cd test && $(CC) $(CFLAGS) -c modlib/src/modlib.c
	cd test && $(CC) $(CFLAGS) -c test.c
	cd test && $(CC) $(CFLAGS) test.o modlib.o master.o slave.o mregisters.o sregisters.o mcoils.o scoils.o mdiscreteinputs.o sdiscreteinputs.o sinputregisters.o minputregisters.o -o test
	cd test && ./test

clean:
	-rm -rf test/modlib
